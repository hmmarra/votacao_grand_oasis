<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Área Administrativa</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script>window.jQuery || document.write('<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"><\/script>');</script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>if (!window.tailwind) { document.write('<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css">'); }</script>
</head>
<body>
  <!-- Tela de Login (mostrada quando não autenticado) -->
  <div id="loginScreen" class="min-h-screen bg-gradient-to-br from-violet-50 to-purple-50 py-6 sm:py-10 px-3 sm:px-4 flex items-center justify-center">
    <div class="max-w-md w-full">
      <div class="bg-white rounded-2xl shadow-xl p-6 sm:p-8">
        <div class="flex flex-col items-center mb-6">
          <div class="p-3 rounded-xl bg-violet-100 text-violet-700 mb-4">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" viewBox="0 0 24 24" fill="currentColor">
              <path fill-rule="evenodd" d="M12 1.5a5.25 5.25 0 0 0-5.25 5.25v3a3 3 0 0 0-3 3v6.75a3 3 0 0 0 3 3h10.5a3 3 0 0 0 3-3v-6.75a3 3 0 0 0-3-3v-3c0-2.9-2.35-5.25-5.25-5.25Zm3.75 8.25v-3a3.75 3.75 0 1 0-7.5 0v3h7.5Z" clip-rule="evenodd"/>
            </svg>
          </div>
          <h1 class="text-2xl font-semibold text-gray-800 mb-2">Acesso Administrativo</h1>
          <p class="text-sm text-gray-500 text-center">Digite seu CPF e senha para acessar a área administrativa</p>
        </div>

        <form id="loginForm" method="post" action="javascript:void(0);" autocomplete="off" onsubmit="return false;">
          <div class="mb-4">
            <label for="cpf" class="block text-sm font-medium text-gray-700 mb-1">CPF</label>
            <input type="text" id="cpf" class="w-full rounded-lg border-gray-300 focus:border-violet-500 focus:ring-violet-500 h-12 text-base" placeholder="Digite seu CPF" required autofocus>
          </div>

          <div class="mb-6">
            <label for="senha" class="block text-sm font-medium text-gray-700 mb-1">Senha</label>
            <input type="password" id="senha" class="w-full rounded-lg border-gray-300 focus:border-violet-500 focus:ring-violet-500 h-12 text-base" placeholder="Digite sua senha" required>
          </div>

          <button type="submit" id="btnLogin" class="w-full inline-flex items-center justify-center gap-2 rounded-lg bg-violet-600 text-white px-5 py-3 hover:bg-violet-700 text-base h-12 font-medium">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor">
              <path fill-rule="evenodd" d="M7.5 3.75a1.5 1.5 0 0 0-1.5 1.5v3.75h-3a.75.75 0 0 0 0 1.5h3v7.5h-3a.75.75 0 0 0 0 1.5h3V21a1.5 1.5 0 0 0 1.5 1.5h9a1.5 1.5 0 0 0 1.5-1.5v-3.75h3a.75.75 0 0 0 0-1.5h-3v-7.5h3a.75.75 0 0 0 0-1.5h-3V5.25a1.5 1.5 0 0 0-1.5-1.5h-9Z" clip-rule="evenodd"/>
            </svg>
            Entrar
          </button>

          <p id="loginMessage" class="hidden mt-4 text-sm text-center"></p>
        </form>

        <div class="mt-6 text-center">
          <button type="button" id="btnVoltarPautas" class="text-sm text-violet-600 hover:text-violet-700 font-medium">
            ← Voltar para votação
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Conteúdo Administrativo (mostrado quando autenticado) -->
  <div id="adminContent" class="min-h-screen bg-gradient-to-br from-violet-50 to-purple-50 py-6 sm:py-10 px-3 sm:px-4 text-sm sm:text-base" style="display: none;">
    <div class="max-w-7xl mx-auto">
      <!-- Header -->
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
        <div class="flex items-center gap-3">
          <div class="p-2 rounded-xl bg-violet-100 text-violet-700">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="currentColor">
              <path fill-rule="evenodd" d="M12 1.5a5.25 5.25 0 0 0-5.25 5.25v3a3 3 0 0 0-3 3v6.75a3 3 0 0 0 3 3h10.5a3 3 0 0 0 3-3v-6.75a3 3 0 0 0-3-3v-3c0-2.9-2.35-5.25-5.25-5.25Zm3.75 8.25v-3a3.75 3.75 0 1 0-7.5 0v3h7.5Z" clip-rule="evenodd"/>
            </svg>
          </div>
          <div>
            <h1 class="text-2xl font-semibold text-gray-800">Área Administrativa</h1>
            <p class="text-sm text-gray-500" id="adminName">Carregando...</p>
          </div>
        </div>
        <div class="flex flex-col sm:flex-row gap-2">
          <button id="btnRefresh" class="w-full sm:w-auto inline-flex items-center justify-center gap-2 rounded-lg bg-violet-600 text-white px-5 py-3 hover:bg-violet-700 text-base h-12">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor">
              <path fill-rule="evenodd" d="M4.755 10.059a6.5 6.5 0 1 1 8.489-8.489 5.25 5.25 0 0 0-1.239 3.659 5.25 5.25 0 0 1-1.24 3.66 6.5 6.5 0 0 1-5.51-3.83ZM12.75 2.5a.75.75 0 0 0-.75.75v4.5a.75.75 0 0 0 1.5 0V4.81l2.22 2.22a.75.75 0 1 0 1.06-1.06l-3.5-3.5a.75.75 0 0 0-1.06 0L11.47 5.97a.75.75 0 0 0 1.28-.53V3.25a.75.75 0 0 0-.75-.75Z" clip-rule="evenodd"/>
            </svg>
            Atualizar
          </button>
          <button id="btnLogout" class="w-full sm:w-auto inline-flex items-center justify-center gap-2 rounded-lg bg-gray-600 text-white px-5 py-3 hover:bg-gray-700 text-base h-12">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor">
              <path fill-rule="evenodd" d="M7.5 3.75A1.5 1.5 0 0 0 6 5.25v13.5a1.5 1.5 0 0 0 1.5 1.5h6a1.5 1.5 0 0 0 1.5-1.5V15a.75.75 0 0 1 1.5 0v3.75a3 3 0 0 1-3 3h-6a3 3 0 0 1-3-3V5.25a3 3 0 0 1 3-3h6a3 3 0 0 1 3 3V9a.75.75 0 0 1-1.5 0V5.25a1.5 1.5 0 0 0-1.5-1.5h-6Zm10.72 4.72a.75.75 0 0 1 1.06 0l3 3a.75.75 0 0 1 0 1.06l-3 3a.75.75 0 1 1-1.06-1.06l1.72-1.72H12a.75.75 0 0 1 0-1.5h8.94l-1.72-1.72a.75.75 0 0 1 0-1.06Z" clip-rule="evenodd"/>
            </svg>
            Sair
          </button>
        </div>
      </div>

      <!-- Tabs -->
      <div class="bg-white rounded-xl shadow mb-6">
        <div class="border-b border-gray-200">
          <nav class="flex -mb-px">
            <button class="tab-btn active px-6 py-3 text-sm font-medium text-violet-600 border-b-2 border-violet-600" data-tab="visualizar">
              Visualizar Pauta
            </button>
            <button class="tab-btn px-6 py-3 text-sm font-medium text-gray-500 hover:text-gray-700 border-b-2 border-transparent" data-tab="pautas">
              Gerenciar Pautas
            </button>
            <button class="tab-btn px-6 py-3 text-sm font-medium text-gray-500 hover:text-gray-700 border-b-2 border-transparent" data-tab="moradores">
              Gerenciar Moradores
            </button>
          </nav>
        </div>

        <!-- Tab Content -->
        <div class="p-6">
          <!-- Tab: Visualizar Pauta -->
          <div id="tab-visualizar" class="tab-content hidden">
            <div class="mb-6">
              <div class="flex flex-col sm:flex-row gap-4 items-start sm:items-end mb-4">
                <div class="flex-1">
                  <label class="block text-sm font-medium text-gray-700 mb-2">Selecione uma Pauta</label>
                  <div class="relative">
                    <select id="selectPauta" class="w-full rounded-lg border-gray-300 focus:border-violet-500 focus:ring-violet-500 h-12" disabled>
                      <option value="">Carregando pautas...</option>
                    </select>
                    <div id="loadingPautas" class="absolute right-3 top-1/2 transform -translate-y-1/2">
                      <svg class="animate-spin h-5 w-5 text-violet-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                      </svg>
                    </div>
                  </div>
                </div>
                <div class="flex gap-2">
                  <button id="btnCarregarPauta" class="inline-flex items-center gap-2 rounded-lg bg-violet-600 text-white px-4 py-2 hover:bg-violet-700 text-sm" disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor">
                      <path fill-rule="evenodd" d="M4.755 10.059a6.5 6.5 0 1 1 8.489-8.489 5.25 5.25 0 0 0-1.239 3.659 5.25 5.25 0 0 1-1.24 3.66 6.5 6.5 0 0 1-5.51-3.83ZM12.75 2.5a.75.75 0 0 0-.75.75v4.5a.75.75 0 0 0 1.5 0V4.81l2.22 2.22a.75.75 0 1 0 1.06-1.06l-3.5-3.5a.75.75 0 0 0-1.06 0L11.47 5.97a.75.75 0 0 0 1.28-.53V3.25a.75.75 0 0 0-.75-.75Z" clip-rule="evenodd"/>
                    </svg>
                    Carregar Dados
                  </button>
                  <button id="btnExportExcel" class="inline-flex items-center gap-2 rounded-lg bg-green-600 text-white px-4 py-2 hover:bg-green-700 text-sm" disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6Z"/>
                      <path d="M14 2v6h6M16 13H8M16 17H8M10 9H8"/>
                    </svg>
                    Exportar Excel
                  </button>
                </div>
              </div>

              <!-- Informações da Pauta -->
              <div id="pautaInfo" class="hidden bg-violet-50 rounded-xl p-6 mb-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Informações da Pauta</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label class="text-sm font-medium text-gray-600">Nome da Pauta</label>
                    <p class="text-base text-gray-800 font-semibold" id="infoNomePauta">-</p>
                  </div>
                  <div>
                    <label class="text-sm font-medium text-gray-600">Status</label>
                    <p class="text-base text-gray-800 font-semibold" id="infoStatus">-</p>
                  </div>
                  <div class="md:col-span-2">
                    <label class="text-sm font-medium text-gray-600">Descrição</label>
                    <p class="text-base text-gray-800" id="infoDescricao">-</p>
                  </div>
                  <div>
                    <label class="text-sm font-medium text-gray-600">Opção 1</label>
                    <p class="text-base text-gray-800" id="infoOpcao1">-</p>
                  </div>
                  <div>
                    <label class="text-sm font-medium text-gray-600">Opção 2</label>
                    <p class="text-base text-gray-800" id="infoOpcao2">-</p>
                  </div>
                  <div>
                    <label class="text-sm font-medium text-gray-600">Opção 3</label>
                    <p class="text-base text-gray-800" id="infoOpcao3">-</p>
                  </div>
                  <div>
                    <label class="text-sm font-medium text-gray-600">Opção 4</label>
                    <p class="text-base text-gray-800" id="infoOpcao4">-</p>
                  </div>
                  <div>
                    <label class="text-sm font-medium text-gray-600">Nome da Aba de Dados</label>
                    <p class="text-base text-gray-800 font-mono" id="infoAba">-</p>
                  </div>
                </div>
              </div>

              <!-- Métricas -->
              <div id="pautaMetrics" class="hidden grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
                <div class="bg-white rounded-xl shadow p-5 border-l-4 border-violet-500">
                  <div class="text-sm text-gray-500 mb-1">Total de Votos</div>
                  <div class="text-2xl font-bold text-gray-800" id="metricTotal">-</div>
                </div>
                <div class="bg-white rounded-xl shadow p-5 border-l-4 border-purple-500">
                  <div class="text-sm text-gray-500 mb-1">Opções Disponíveis</div>
                  <div class="text-2xl font-bold text-gray-800" id="metricOpcoes">-</div>
                </div>
                <div class="bg-white rounded-xl shadow p-5 border-l-4 border-indigo-500">
                  <div class="text-sm text-gray-500 mb-1">Última Atualização</div>
                  <div class="text-sm font-semibold text-gray-800" id="metricTime">-</div>
                </div>
              </div>

              <!-- Placar -->
              <div id="pautaPlacar" class="hidden mb-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Placar</h3>
                <div id="pautaScores" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4"></div>
              </div>

              <!-- Lista de Votos -->
              <div id="pautaVotes" class="hidden">
                <div class="flex justify-between items-center mb-4">
                  <h3 class="text-lg font-semibold text-gray-800">Lista de Votos</h3>
                </div>
                <div class="overflow-x-auto">
                  <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-violet-50">
                      <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase">CPF</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase">Nome</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase">Apto</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase">Torre</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase">Voto</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase">Data/Hora</th>
                      </tr>
                    </thead>
                    <tbody id="pautaVotesBody" class="bg-white divide-y divide-gray-200">
                      <tr><td colspan="6" class="px-4 py-4 text-center text-gray-500">Carregando...</td></tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <!-- Tab: Gerenciar Pautas -->
          <div id="tab-pautas" class="tab-content hidden">
            <div class="mb-4 flex justify-between items-center">
              <h2 class="text-lg font-semibold text-gray-800">Gerenciar Pautas</h2>
              <button id="btnNovaPauta" class="inline-flex items-center gap-2 rounded-lg bg-violet-600 text-white px-4 py-2 hover:bg-violet-700 text-sm">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M11.25 4.533A9.707 9.707 0 0 1 6 3a9.735 9.735 0 0 0-3.25.555.75.75 0 0 0-.5.707v14.25a.75.75 0 0 0 .5.707c1.35.372 2.75.555 4.25.555a9.707 9.707 0 0 1 5.25-1.533m6.75-1.533a9.707 9.707 0 0 1 5.25 1.533 9.735 9.735 0 0 0 3.25-.555.75.75 0 0 1 .5.707v14.25a.75.75 0 0 1-.5.707c-1.35.372-2.75.555-4.25.555a9.707 9.707 0 0 1-5.25-1.533M4.5 19.5v-15h12v15H4.5Z"/>
                </svg>
                Nova Pauta
              </button>
            </div>
            <div class="overflow-x-auto">
              <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-violet-50">
                  <tr>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase">Nome</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase">Descrição</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase">Opções</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase">Status</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase">Aba</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase">Ações</th>
                  </tr>
                </thead>
                <tbody id="pautasTableBody" class="bg-white divide-y divide-gray-200">
                  <tr><td colspan="6" class="px-4 py-4 text-center text-gray-500">Carregando...</td></tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Tab: Gerenciar Moradores -->
          <div id="tab-moradores" class="tab-content hidden">
            <div class="mb-6">
              <h2 class="text-lg font-semibold text-gray-800 mb-4">Gerenciar Moradores</h2>
              
              <!-- Upload de Excel -->
              <div class="bg-violet-50 rounded-xl p-6 mb-6">
                <h3 class="text-md font-semibold text-gray-800 mb-3">Upload de Planilha Excel</h3>
                <p class="text-sm text-gray-600 mb-4">Faça upload de uma planilha Excel (.xlsx) com as colunas: CPF, Nome, Apartamento, Torre. Os registros serão atualizados ou inseridos com base nas colunas chave (Apartamento e Torre).</p>
                <form id="uploadForm">
                  <div class="flex flex-col sm:flex-row gap-4 items-start sm:items-end">
                    <div class="flex-1">
                      <label class="block text-sm font-medium text-gray-700 mb-2">Selecione o arquivo Excel</label>
                      <input type="file" id="fileInput" accept=".xlsx,.xls" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-violet-600 file:text-white hover:file:bg-violet-700">
                    </div>
                    <button type="submit" id="btnUpload" class="inline-flex items-center gap-2 rounded-lg bg-violet-600 text-white px-5 py-2 hover:bg-violet-700 text-sm h-10">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M11.47 1.72a.75.75 0 0 1 1.06 0l3 3a.75.75 0 0 1-1.06 1.06L12 3.31 9.53 5.78a.75.75 0 0 1-1.06-1.06l3-3ZM11.25 7.5v11.69l-1.22-1.22a.75.75 0 1 0-1.06 1.06l2.5 2.5a.75.75 0 0 0 1.06 0l2.5-2.5a.75.75 0 1 0-1.06-1.06l-1.22 1.22V7.5Z"/>
                      </svg>
                      Upload
                    </button>
                  </div>
                  <div class="mt-3 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                    <p class="text-xs text-yellow-800">
                      <strong>⚠️ Importante:</strong> Na primeira vez, será solicitada autorização para acessar o Google Drive. 
                      Se aparecer erro de permissão, acesse o <strong>Editor de Scripts do Google Apps Script</strong> e execute qualquer função manualmente uma vez para conceder as permissões necessárias.
                    </p>
                  </div>
                </form>
                <p id="uploadMessage" class="hidden mt-3 text-sm"></p>
              </div>

              <!-- Lista de Moradores -->
              <div class="mb-4 flex justify-between items-center">
                <h3 class="text-md font-semibold text-gray-800">Lista de Moradores</h3>
                <button id="btnRefreshMoradores" class="inline-flex items-center gap-2 rounded-lg bg-gray-600 text-white px-4 py-2 hover:bg-gray-700 text-sm">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor">
                    <path fill-rule="evenodd" d="M4.755 10.059a6.5 6.5 0 1 1 8.489-8.489 5.25 5.25 0 0 0-1.239 3.659 5.25 5.25 0 0 1-1.24 3.66 6.5 6.5 0 0 1-5.51-3.83ZM12.75 2.5a.75.75 0 0 0-.75.75v4.5a.75.75 0 0 0 1.5 0V4.81l2.22 2.22a.75.75 0 1 0 1.06-1.06l-3.5-3.5a.75.75 0 0 0-1.06 0L11.47 5.97a.75.75 0 0 0 1.28-.53V3.25a.75.75 0 0 0-.75-.75Z" clip-rule="evenodd"/>
                  </svg>
                  Atualizar
                </button>
              </div>
              <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                  <thead class="bg-violet-50">
                    <tr>
                      <th class="px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase">CPF</th>
                      <th class="px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase">Nome</th>
                      <th class="px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase">Apartamento</th>
                      <th class="px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase">Torre</th>
                      <th class="px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase">Ações</th>
                    </tr>
                  </thead>
                  <tbody id="moradoresTableBody" class="bg-white divide-y divide-gray-200">
                    <tr><td colspan="5" class="px-4 py-4 text-center text-gray-500">Carregando...</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>

      <p id="message" class="hidden mt-4 text-sm text-center"></p>
    </div>
  </div>

  <script>
    function setStatusMessage(text, type) {
      var el = $('#message');
      el.removeClass('hidden').removeClass('text-red-600').removeClass('text-violet-700');
      if (type === 'error') {
        el.addClass('text-red-600');
      } else {
        el.addClass('text-violet-700');
      }
      el.text(text);
    }

    function navigateTo(view) {
      // Redirecionamento compatível com Google Apps Script
      try {
        var currentUrl = window.location.href;
        var baseUrl = currentUrl.split('?')[0];
        var newUrl = baseUrl + '?view=' + encodeURIComponent(view);
        
        // Tenta múltiplas abordagens para garantir o redirecionamento
        if (window.top && window.top !== window) {
          window.top.location.href = newUrl;
        } else {
          window.location.href = newUrl;
        }
      } catch (e) {
        // Fallback: cria link e clica
        try {
          var a = document.createElement('a');
          a.href = '?view=' + encodeURIComponent(view);
          a.target = '_top';
          document.body.appendChild(a);
          a.click();
          setTimeout(function() {
            if (a.parentNode) {
              document.body.removeChild(a);
            }
          }, 100);
        } catch (e2) {
          console.error('Erro ao redirecionar:', e2);
          // Último recurso: recarrega a página
          window.location.reload();
        }
      }
    }

    function formatCPF(cpf) {
      return cpf.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
    }

    function renderScores(scores, containerId, colorClass) {
      var counts = scores.counts || {};
      var total = scores.total || 0;
      var candidatos = Object.keys(counts).sort();
      var html = '';
      candidatos.forEach(function(nome){
        var count = counts[nome] || 0;
        var pct = total ? Math.round(count * 100 / total) : 0;
        html += '<div class="bg-white rounded-lg p-4 border border-gray-200">' +
          '<div class="flex items-center justify-between mb-2">' +
            '<span class="font-medium text-gray-800">' + nome + '</span>' +
            '<span class="text-sm text-gray-500">' + count + ' voto(s)</span>' +
          '</div>' +
          '<div class="w-full h-2 bg-gray-100 rounded-full overflow-hidden">' +
            '<div class="h-2 ' + colorClass + '" style="width:' + pct + '%"></div>' +
          '</div>' +
          '<div class="mt-1 text-xs text-gray-500">' + pct + '%</div>' +
        '</div>';
      });
      if (candidatos.length === 0) {
        html = '<div class="text-gray-500 text-center">Nenhum voto registrado ainda</div>';
      }
      $(containerId).html(html);
    }

    function renderVotes(votes, containerId) {
      if (!votes || votes.length === 0) {
        $(containerId).html('<tr><td colspan="6" class="px-4 py-4 text-center text-gray-500">Nenhum voto registrado ainda</td></tr>');
        return;
      }
      var html = '';
      votes.forEach(function(vote){
        html += '<tr class="hover:bg-gray-50">' +
          '<td class="px-4 py-3 text-sm text-gray-700">' + formatCPF(vote.cpf) + '</td>' +
          '<td class="px-4 py-3 text-sm text-gray-700">' + vote.nome + '</td>' +
          '<td class="px-4 py-3 text-sm text-gray-700">' + vote.apartamento + '</td>' +
          '<td class="px-4 py-3 text-sm text-gray-700">' + vote.torre + '</td>' +
          '<td class="px-4 py-3 text-sm font-medium text-gray-800">' + vote.voto + '</td>' +
          '<td class="px-4 py-3 text-sm text-gray-500">' + vote.timestamp + '</td>' +
        '</tr>';
      });
      $(containerId).html(html);
    }

    function loadAdminData() {
      // Não precisa mais carregar dados antigos
    }

    function setLoginMessage(text, type) {
      var el = $('#loginMessage');
      el.removeClass('hidden').removeClass('text-red-600').removeClass('text-violet-700');
      if (type === 'error') {
        el.addClass('text-red-600');
      } else {
        el.addClass('text-violet-700');
      }
      el.text(text);
    }

    function showAdminContent() {
      $('#loginScreen').hide();
      $('#adminContent').show();
    }

    function showLoginScreen() {
      $('#adminContent').hide();
      $('#loginScreen').show();
    }

    $(function(){
      // Limpa qualquer parâmetro da URL que possa ter sido adicionado
      if (window.location.search && (window.location.search.indexOf('cpf=') !== -1 || window.location.search.indexOf('senha=') !== -1)) {
        var url = window.location.href.split('?')[0];
        if (window.history && window.history.replaceState) {
          window.history.replaceState({}, document.title, url);
        }
      }
      
      // Check authentication
      var auth = sessionStorage.getItem('adminAuth');
      if (!auth) {
        showLoginScreen();
        // Não retorna aqui, continua para configurar os event handlers
      } else {
        try {
          var adminData = JSON.parse(auth);
          $('#adminName').text('Bem-vindo, ' + adminData.nome);
          showAdminContent();
          // Carrega dados iniciais se autenticado
          loadPautas();
          loadMoradores();
          $('#tab-visualizar').removeClass('hidden');
          loadPautasSelect(false);
        } catch (e) {
          sessionStorage.removeItem('adminAuth');
          showLoginScreen();
        }
      }

      // Tabs
      $('.tab-btn').on('click', function(){
        var tab = $(this).data('tab');
        $('.tab-btn').removeClass('active text-violet-600 border-violet-600').addClass('text-gray-500 border-transparent');
        $(this).addClass('active text-violet-600 border-violet-600').removeClass('text-gray-500 border-transparent');
        $('.tab-content').addClass('hidden');
        $('#tab-' + tab).removeClass('hidden');
        
        // Carrega dados quando abrir as abas
        if (tab === 'visualizar') {
          // Só recarrega se o select estiver vazio ou com erro
          var select = $('#selectPauta');
          if (select.prop('disabled') || select.find('option').length <= 1) {
            loadPautasSelect(false); // Usa cache se disponível
          }
          hidePautaData();
        }
        if (tab === 'moradores') {
          loadMoradores();
        }
      });
      
      // Select de pautas - habilita/desabilita botão de carregar
      $('#selectPauta').off('change').on('change', function(){
        var abaNome = $(this).val();
        if (abaNome) {
          $('#btnCarregarPauta').prop('disabled', false);
          $('#btnExportExcel').prop('disabled', true);
          hidePautaData();
        } else {
          $('#btnCarregarPauta').prop('disabled', true);
          $('#btnExportExcel').prop('disabled', true);
          hidePautaData();
        }
      });
      
      // Botão para carregar dados da pauta
      $('#btnCarregarPauta').off('click').on('click', function(){
        var abaNome = $('#selectPauta').val();
        if (abaNome) {
          $(this).prop('disabled', true).html('<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 animate-spin" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M4.755 10.059a6.5 6.5 0 1 1 8.489-8.489 5.25 5.25 0 0 0-1.239 3.659 5.25 5.25 0 0 1-1.24 3.66 6.5 6.5 0 0 1-5.51-3.83ZM12.75 2.5a.75.75 0 0 0-.75.75v4.5a.75.75 0 0 0 1.5 0V4.81l2.22 2.22a.75.75 0 1 0 1.06-1.06l-3.5-3.5a.75.75 0 0 0-1.06 0L11.47 5.97a.75.75 0 0 0 1.28-.53V3.25a.75.75 0 0 0-.75-.75Z" clip-rule="evenodd"/></svg> Carregando...');
          loadPautaData(abaNome);
        }
      });
      
      // Botão de exportação Excel
      $('#btnExportExcel').off('click').on('click', function(){
        var abaNome = $('#selectPauta').val();
        if (abaNome) {
          exportToExcel(abaNome);
        }
      });

      // Buttons
      $('#btnRefresh').on('click', function(){
        loadPautas();
        loadMoradores();
        // Força refresh do cache de pautas
        loadPautasSelect(true);
        setStatusMessage('Dados atualizados!', 'ok');
        setTimeout(function(){ $('#message').addClass('hidden'); }, 2000);
      });
      
      $('#btnRefreshMoradores').on('click', function(){
        loadMoradores();
      });

      $('#btnLogout').on('click', function(){
        sessionStorage.removeItem('adminAuth');
        showLoginScreen();
        $('#cpf').focus();
      });

      // Formulário de Login
      $('#loginForm').on('submit', function(e){
        e.preventDefault();
        e.stopPropagation();
        return false;
      });
      
      $('#btnLogin').on('click', function(e){
        e.preventDefault();
        e.stopPropagation();
        var cpf = $('#cpf').val().trim();
        var senha = $('#senha').val();
        if (!cpf || !senha) {
          setLoginMessage('Por favor, preencha todos os campos.', 'error');
          return false;
        }
        $('#btnLogin').prop('disabled', true).addClass('opacity-60');
        google.script.run
          .withSuccessHandler(function(res){
            if (res && res.success) {
              sessionStorage.setItem('adminAuth', JSON.stringify(res));
              $('#adminName').text('Bem-vindo, ' + res.nome);
              showAdminContent();
              // Limpa o formulário
              $('#cpf').val('');
              $('#senha').val('');
              // Carrega dados iniciais
              loadPautas();
              loadMoradores();
              $('#tab-visualizar').removeClass('hidden');
              loadPautasSelect(false);
            } else {
              setLoginMessage('Credenciais inválidas.', 'error');
              $('#btnLogin').prop('disabled', false).removeClass('opacity-60');
            }
          })
          .withFailureHandler(function(e){
            setLoginMessage((e && e.message) ? e.message : 'Erro ao fazer login. Verifique suas credenciais.', 'error');
            $('#btnLogin').prop('disabled', false).removeClass('opacity-60');
          })
          .authenticateAdmin(cpf, senha);
        return false;
      });

      // Botão Voltar - navega para a página de pautas
      $('#btnVoltarPautas').on('click', function(e){
        e.preventDefault();
        e.stopPropagation();
        
        // Obtém a URL do web app do backend
        google.script.run
          .withSuccessHandler(function(webAppUrl){
            if (webAppUrl) {
              var newUrl = webAppUrl + (webAppUrl.indexOf('?') === -1 ? '?' : '&') + 'view=pautas';
              if (window.top && window.top !== window) {
                window.top.location.href = newUrl;
              } else {
                window.location.href = newUrl;
              }
            } else {
              // Fallback: tenta construir a URL manualmente
              var currentUrl = window.location.href;
              // Remove o domínio do painel e constrói a URL do exec
              if (currentUrl.indexOf('/userCodeAppPanel') !== -1) {
                // Se estiver no painel, tenta extrair o ID do script
                var match = currentUrl.match(/\/s\/([^\/]+)/);
                if (match) {
                  var scriptId = match[1];
                  var newUrl = 'https://script.google.com/macros/s/' + scriptId + '/exec?view=pautas';
                  if (window.top && window.top !== window) {
                    window.top.location.href = newUrl;
                  } else {
                    window.location.href = newUrl;
                  }
                }
              } else {
                var baseUrl = currentUrl.split('?')[0];
                var newUrl = baseUrl + '?view=pautas';
                if (window.top && window.top !== window) {
                  window.top.location.href = newUrl;
                } else {
                  window.location.href = newUrl;
                }
              }
            }
          })
          .withFailureHandler(function(e){
            // Fallback: tenta construir a URL manualmente
            var currentUrl = window.location.href;
            if (currentUrl.indexOf('/userCodeAppPanel') !== -1) {
              // Se estiver no painel, tenta extrair o ID do script
              var match = currentUrl.match(/\/s\/([^\/]+)/);
              if (match) {
                var scriptId = match[1];
                var newUrl = 'https://script.google.com/macros/s/' + scriptId + '/exec?view=pautas';
                if (window.top && window.top !== window) {
                  window.top.location.href = newUrl;
                } else {
                  window.location.href = newUrl;
                }
              }
            } else {
              var baseUrl = currentUrl.split('?')[0];
              var newUrl = baseUrl + '?view=pautas';
              if (window.top && window.top !== window) {
                window.top.location.href = newUrl;
              } else {
                window.location.href = newUrl;
              }
            }
          })
          .getWebAppUrl();
        return false;
      });

      $('#btnNovaPauta').on('click', function(){
        openPautaModal();
      });

      // Dados já são carregados acima quando autenticado, não precisa carregar novamente aqui
      
      // Upload de Excel
      $('#uploadForm').off('submit').on('submit', function(e){
        e.preventDefault();
        var fileInput = $('#fileInput')[0];
        if (!fileInput.files || fileInput.files.length === 0) {
          setStatusMessage('Por favor, selecione um arquivo Excel.', 'error');
          return;
        }
        var file = fileInput.files[0];
        var reader = new FileReader();
        reader.onload = function(e) {
          var data = e.target.result;
          // Converte para base64
          var base64 = btoa(String.fromCharCode.apply(null, new Uint8Array(data)));
          $('#btnUpload').prop('disabled', true).html('Processando...');
          google.script.run
            .withSuccessHandler(function(result){
              $('#btnUpload').prop('disabled', false).html('<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor"><path d="M11.47 1.72a.75.75 0 0 1 1.06 0l3 3a.75.75 0 0 1-1.06 1.06L12 3.31 9.53 5.78a.75.75 0 0 1-1.06-1.06l3-3ZM11.25 7.5v11.69l-1.22-1.22a.75.75 0 1 0-1.06 1.06l2.5 2.5a.75.75 0 0 0 1.06 0l2.5-2.5a.75.75 0 1 0-1.06-1.06l-1.22 1.22V7.5Z"/></svg> Upload');
              $('#uploadMessage').removeClass('hidden').addClass('text-green-600').text('Upload realizado com sucesso! ' + result.inserted + ' registros inseridos, ' + result.updated + ' registros atualizados.');
              $('#fileInput').val('');
              loadMoradores();
            })
            .withFailureHandler(function(e){
              $('#btnUpload').prop('disabled', false).html('<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor"><path d="M11.47 1.72a.75.75 0 0 1 1.06 0l3 3a.75.75 0 0 1-1.06 1.06L12 3.31 9.53 5.78a.75.75 0 0 1-1.06-1.06l3-3ZM11.25 7.5v11.69l-1.22-1.22a.75.75 0 1 0-1.06 1.06l2.5 2.5a.75.75 0 0 0 1.06 0l2.5-2.5a.75.75 0 1 0-1.06-1.06l-1.22 1.22V7.5Z"/></svg> Upload');
              var errorMsg = e && e.message ? e.message : String(e);
              var fullMsg = 'Erro ao processar arquivo: ' + errorMsg;
              
              // Mensagem especial para erro de permissão
              if (errorMsg.indexOf('permissão') !== -1 || errorMsg.indexOf('permission') !== -1 || errorMsg.indexOf('authorization') !== -1) {
                fullMsg = '⚠️ Autorização necessária: É necessário autorizar o acesso ao Google Drive. ' +
                         'Por favor, acesse o Editor de Scripts do Google Apps Script e execute qualquer função manualmente uma vez para conceder as permissões. ' +
                         'Após autorizar, tente novamente o upload.';
              }
              
              $('#uploadMessage').removeClass('hidden').addClass('text-red-600').html(fullMsg.replace(/\n/g, '<br>'));
            })
            .processExcelUpload(base64, file.name);
        };
        reader.readAsArrayBuffer(file);
      });
    });
    
    function loadMoradores() {
      google.script.run
        .withSuccessHandler(function(moradores){
          renderMoradoresTable(moradores);
        })
        .withFailureHandler(function(e){
          $('#moradoresTableBody').html('<tr><td colspan="5" class="px-4 py-4 text-center text-red-500">Erro ao carregar moradores: ' + (e && e.message ? e.message : e) + '</td></tr>');
        })
        .getAllMoradores();
    }
    
    function renderMoradoresTable(moradores) {
      if (!moradores || moradores.length === 0) {
        $('#moradoresTableBody').html('<tr><td colspan="5" class="px-4 py-4 text-center text-gray-500">Nenhum morador cadastrado</td></tr>');
        return;
      }
      var html = '';
      moradores.forEach(function(morador){
        html += '<tr class="hover:bg-gray-50">' +
          '<td class="px-4 py-3 text-sm text-gray-700">' + formatCPF(morador.cpf) + '</td>' +
          '<td class="px-4 py-3 text-sm text-gray-700">' + morador.nome + '</td>' +
          '<td class="px-4 py-3 text-sm text-gray-700">' + morador.apartamento + '</td>' +
          '<td class="px-4 py-3 text-sm text-gray-700">' + morador.torre + '</td>' +
          '<td class="px-4 py-3 text-sm">' +
            '<button class="btn-delete-morador text-red-600 hover:text-red-700" data-row="' + morador.rowIndex + '">Excluir</button>' +
          '</td>' +
        '</tr>';
      });
      $('#moradoresTableBody').html(html);
      
      $('.btn-delete-morador').off('click').on('click', function(){
        var rowIndex = $(this).data('row');
        if (confirm('Tem certeza que deseja excluir este morador?')) {
          google.script.run
            .withSuccessHandler(function(){
              loadMoradores();
              setStatusMessage('Morador excluído com sucesso!', 'ok');
            })
            .withFailureHandler(function(e){
              setStatusMessage('Erro ao excluir morador: ' + (e && e.message ? e.message : e), 'error');
            })
            .deleteMorador(rowIndex);
        }
      });
    }
    
    // Cache simples para pautas (5 minutos)
    var pautasCache = null;
    var pautasCacheTime = null;
    var CACHE_DURATION = 5 * 60 * 1000; // 5 minutos
    
    function loadPautasSelect(forceRefresh) {
      var select = $('#selectPauta');
      var loadingIndicator = $('#loadingPautas');
      
      // Verifica cache se não for refresh forçado
      if (!forceRefresh && pautasCache && pautasCacheTime && (Date.now() - pautasCacheTime < CACHE_DURATION)) {
        renderPautasSelect(pautasCache);
        return;
      }
      
      // Mostra estado de loading
      select.prop('disabled', true).html('<option value="">Carregando pautas...</option>');
      loadingIndicator.removeClass('hidden');
      
      // Timeout de segurança (30 segundos)
      var timeoutId = setTimeout(function(){
        if (select.prop('disabled')) {
          select.prop('disabled', false).html('<option value="">Erro ao carregar. Clique para tentar novamente.</option>');
          loadingIndicator.addClass('hidden');
          setStatusMessage('Timeout ao carregar pautas. Tente novamente.', 'error');
        }
      }, 30000);
      
      google.script.run
        .withSuccessHandler(function(pautas){
          clearTimeout(timeoutId);
          loadingIndicator.addClass('hidden');
          
          // Atualiza cache
          pautasCache = pautas;
          pautasCacheTime = Date.now();
          
          renderPautasSelect(pautas);
        })
        .withFailureHandler(function(e){
          clearTimeout(timeoutId);
          loadingIndicator.addClass('hidden');
          select.prop('disabled', false);
          select.html('<option value="">Erro ao carregar. Clique para tentar novamente.</option>');
          setStatusMessage('Erro ao carregar pautas: ' + (e && e.message ? e.message : e), 'error');
          
          // Retry automático após 3 segundos (máximo 3 tentativas)
          if (!window.pautasRetryCount) window.pautasRetryCount = 0;
          if (window.pautasRetryCount < 3) {
            window.pautasRetryCount++;
            setTimeout(function(){
              if ($('#tab-visualizar').is(':visible')) {
                loadPautasSelect(true);
              }
            }, 3000);
          } else {
            window.pautasRetryCount = 0;
          }
        })
        .getAllPautas();
    }
    
    function renderPautasSelect(pautas) {
      var select = $('#selectPauta');
      select.prop('disabled', false);
      select.empty();
      select.append('<option value="">-- Selecione uma pauta --</option>');
      
      if (!pautas || pautas.length === 0) {
        select.append('<option value="">Nenhuma pauta cadastrada</option>');
        setStatusMessage('Nenhuma pauta encontrada.', 'ok');
        return;
      }
      
      pautas.forEach(function(pauta){
        select.append('<option value="' + pauta.aba + '">' + pauta.nomePauta + '</option>');
      });
      
      // Mensagem de sucesso discreta
      if (pautas.length > 0) {
        console.log('Pautas carregadas: ' + pautas.length);
      }
    }
    
    function loadPautaData(abaNome) {
      // Busca informações da pauta
      google.script.run
        .withSuccessHandler(function(pauta){
          if (pauta) {
            showPautaInfo(pauta);
          }
        })
        .withFailureHandler(function(e){
          console.error('Erro ao buscar pauta:', e);
          $('#btnCarregarPauta').prop('disabled', false).html('<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M4.755 10.059a6.5 6.5 0 1 1 8.489-8.489 5.25 5.25 0 0 0-1.239 3.659 5.25 5.25 0 0 1-1.24 3.66 6.5 6.5 0 0 1-5.51-3.83ZM12.75 2.5a.75.75 0 0 0-.75.75v4.5a.75.75 0 0 0 1.5 0V4.81l2.22 2.22a.75.75 0 1 0 1.06-1.06l-3.5-3.5a.75.75 0 0 0-1.06 0L11.47 5.97a.75.75 0 0 0 1.28-.53V3.25a.75.75 0 0 0-.75-.75Z" clip-rule="evenodd"/></svg> Carregar Dados');
          setStatusMessage('Erro ao carregar dados da pauta: ' + (e && e.message ? e.message : e), 'error');
        })
        .getPautaByAba(abaNome);
      
      // Busca estatísticas e votos
      google.script.run
        .withSuccessHandler(function(stats){
          showPautaStats(stats);
          $('#btnExportExcel').prop('disabled', false);
          $('#btnCarregarPauta').prop('disabled', false).html('<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M4.755 10.059a6.5 6.5 0 1 1 8.489-8.489 5.25 5.25 0 0 0-1.239 3.659 5.25 5.25 0 0 1-1.24 3.66 6.5 6.5 0 0 1-5.51-3.83ZM12.75 2.5a.75.75 0 0 0-.75.75v4.5a.75.75 0 0 0 1.5 0V4.81l2.22 2.22a.75.75 0 1 0 1.06-1.06l-3.5-3.5a.75.75 0 0 0-1.06 0L11.47 5.97a.75.75 0 0 0 1.28-.53V3.25a.75.75 0 0 0-.75-.75Z" clip-rule="evenodd"/></svg> Carregar Dados');
        })
        .withFailureHandler(function(e){
          setStatusMessage('Erro ao carregar dados da pauta: ' + (e && e.message ? e.message : e), 'error');
          $('#btnCarregarPauta').prop('disabled', false).html('<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M4.755 10.059a6.5 6.5 0 1 1 8.489-8.489 5.25 5.25 0 0 0-1.239 3.659 5.25 5.25 0 0 1-1.24 3.66 6.5 6.5 0 0 1-5.51-3.83ZM12.75 2.5a.75.75 0 0 0-.75.75v4.5a.75.75 0 0 0 1.5 0V4.81l2.22 2.22a.75.75 0 1 0 1.06-1.06l-3.5-3.5a.75.75 0 0 0-1.06 0L11.47 5.97a.75.75 0 0 0 1.28-.53V3.25a.75.75 0 0 0-.75-.75Z" clip-rule="evenodd"/></svg> Carregar Dados');
        })
        .getPautaStats(abaNome);
    }
    
    function showPautaInfo(pauta) {
      $('#infoNomePauta').text(pauta.nomePauta || '-');
      $('#infoDescricao').text(pauta.descricao || '-');
      $('#infoStatus').html('<span class="px-2 py-1 rounded-full text-xs font-medium ' + 
        (pauta.status === 'Votação Liberada' ? 'bg-green-100 text-green-800' : 
         pauta.status === 'Votação Encerrada' ? 'bg-red-100 text-red-800' : 
         'bg-yellow-100 text-yellow-800') + '">' + pauta.status + '</span>');
      $('#infoOpcao1').text(pauta.opcoes[0] || 'Não Aplica');
      $('#infoOpcao2').text(pauta.opcoes[1] || 'Não Aplica');
      $('#infoOpcao3').text(pauta.opcoes[2] || 'Não Aplica');
      $('#infoOpcao4').text(pauta.opcoes[3] || 'Não Aplica');
      $('#infoAba').text(pauta.aba || '-');
      $('#pautaInfo').removeClass('hidden');
    }
    
    function showPautaStats(stats) {
      // Métricas
      $('#metricTotal').text(stats.totalVotes || 0);
      $('#metricOpcoes').text(Object.keys(stats.scores.counts || {}).length);
      $('#metricTime').text(new Date().toLocaleString('pt-BR'));
      $('#pautaMetrics').removeClass('hidden');
      
      // Placar
      renderScores(stats.scores, '#pautaScores', 'bg-gradient-to-r from-violet-500 to-purple-500');
      $('#pautaPlacar').removeClass('hidden');
      
      // Lista de votos
      renderVotes(stats.votes, '#pautaVotesBody');
      $('#pautaVotes').removeClass('hidden');
    }
    
    function hidePautaData() {
      $('#pautaInfo, #pautaMetrics, #pautaPlacar, #pautaVotes').addClass('hidden');
      $('#btnExportExcel').prop('disabled', true);
    }
    
    function exportToExcel(abaNome) {
      $('#btnExportExcel').prop('disabled', true).html('<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6Z"/><path d="M14 2v6h6M16 13H8M16 17H8M10 9H8"/></svg> Gerando...');
      google.script.run
        .withSuccessHandler(function(result){
          // Abre a nova planilha gerada
          window.open(result.url, '_blank');
          $('#btnExportExcel').prop('disabled', false).html('<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6Z"/><path d="M14 2v6h6M16 13H8M16 17H8M10 9H8"/></svg> Exportar Excel');
          setStatusMessage('Arquivo Excel gerado com sucesso! Abra em nova aba.', 'ok');
        })
        .withFailureHandler(function(e){
          setStatusMessage('Erro ao exportar Excel: ' + (e && e.message ? e.message : e), 'error');
          $('#btnExportExcel').prop('disabled', false).html('<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6Z"/><path d="M14 2v6h6M16 13H8M16 17H8M10 9H8"/></svg> Exportar Excel');
        })
        .exportPautaToExcel(abaNome);
    }
    

    function loadPautas() {
      google.script.run
        .withSuccessHandler(function(pautas){
          renderPautasTable(pautas);
        })
        .withFailureHandler(function(e){
          $('#pautasTableBody').html('<tr><td colspan="6" class="px-4 py-4 text-center text-red-500">Erro ao carregar pautas: ' + (e && e.message ? e.message : e) + '</td></tr>');
        })
        .getAllPautas();
    }

    function renderPautasTable(pautas) {
      if (!pautas || pautas.length === 0) {
        $('#pautasTableBody').html('<tr><td colspan="6" class="px-4 py-4 text-center text-gray-500">Nenhuma pauta cadastrada</td></tr>');
        return;
      }
      var html = '';
      pautas.forEach(function(pauta){
        var statusClass = pauta.status === 'Votação Liberada' ? 'bg-green-100 text-green-800' : 
                         pauta.status === 'Votação Encerrada' ? 'bg-red-100 text-red-800' : 
                         'bg-yellow-100 text-yellow-800';
        html += '<tr class="hover:bg-gray-50">' +
          '<td class="px-4 py-3 text-sm font-medium text-gray-800">' + pauta.nomePauta + '</td>' +
          '<td class="px-4 py-3 text-sm text-gray-600">' + (pauta.descricao || '-') + '</td>' +
          '<td class="px-4 py-3 text-sm text-gray-600">' + pauta.opcoes.join(', ') + '</td>' +
          '<td class="px-4 py-3 text-sm">' +
            '<span class="px-2 py-1 rounded-full text-xs font-medium ' + statusClass + '">' + pauta.status + '</span>' +
          '</td>' +
          '<td class="px-4 py-3 text-sm text-gray-600">' + pauta.aba + '</td>' +
          '<td class="px-4 py-3 text-sm">' +
            '<div class="flex gap-2">' +
              '<button class="btn-edit-pauta text-violet-600 hover:text-violet-700" data-row="' + pauta.rowIndex + '">Editar</button>' +
              '<button class="btn-delete-pauta text-red-600 hover:text-red-700" data-row="' + pauta.rowIndex + '">Excluir</button>' +
            '</div>' +
          '</td>' +
        '</tr>';
      });
      $('#pautasTableBody').html(html);
      
      // Event handlers
      $('.btn-edit-pauta').off('click').on('click', function(){
        var rowIndex = $(this).data('row');
        var pauta = pautas.find(function(p) { return p.rowIndex === rowIndex; });
        if (pauta) openPautaModal(pauta);
      });
      
      $('.btn-delete-pauta').off('click').on('click', function(){
        var rowIndex = $(this).data('row');
        if (confirm('Tem certeza que deseja excluir esta pauta?')) {
          google.script.run
            .withSuccessHandler(function(){
              loadPautas();
              setStatusMessage('Pauta excluída com sucesso!', 'ok');
            })
            .withFailureHandler(function(e){
              setStatusMessage('Erro ao excluir pauta: ' + (e && e.message ? e.message : e), 'error');
            })
            .deletePauta(rowIndex);
        }
      });
    }

    function openPautaModal(pauta) {
      // Criar modal simples (pode ser melhorado depois)
      var isEdit = !!pauta;
      var modalHtml = '<div id="pautaModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/50">' +
        '<div class="bg-white rounded-xl shadow-xl p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">' +
          '<h3 class="text-lg font-semibold text-gray-800 mb-4">' + (isEdit ? 'Editar Pauta' : 'Nova Pauta') + '</h3>' +
          '<form id="pautaForm">' +
            '<div class="mb-4">' +
              '<label class="block text-sm font-medium text-gray-700 mb-1">Nome da Pauta</label>' +
              '<input type="text" id="modalNomePauta" class="w-full rounded-lg border-gray-300" value="' + (pauta ? pauta.nomePauta : '') + '" required>' +
            '</div>' +
            '<div class="mb-4">' +
              '<label class="block text-sm font-medium text-gray-700 mb-1">Descrição</label>' +
              '<textarea id="modalDescricao" class="w-full rounded-lg border-gray-300" rows="2">' + (pauta ? pauta.descricao : '') + '</textarea>' +
            '</div>' +
            '<div class="grid grid-cols-2 gap-4 mb-4">' +
              '<div><label class="block text-sm font-medium text-gray-700 mb-1">Opção 1</label><input type="text" id="modalOpcao1" class="w-full rounded-lg border-gray-300" value="' + (pauta ? pauta.opcao1 : '') + '"></div>' +
              '<div><label class="block text-sm font-medium text-gray-700 mb-1">Opção 2</label><input type="text" id="modalOpcao2" class="w-full rounded-lg border-gray-300" value="' + (pauta ? pauta.opcao2 : '') + '"></div>' +
              '<div><label class="block text-sm font-medium text-gray-700 mb-1">Opção 3</label><input type="text" id="modalOpcao3" class="w-full rounded-lg border-gray-300" value="' + (pauta ? pauta.opcao3 : '') + '"></div>' +
              '<div><label class="block text-sm font-medium text-gray-700 mb-1">Opção 4</label><input type="text" id="modalOpcao4" class="w-full rounded-lg border-gray-300" value="' + (pauta ? pauta.opcao4 : '') + '"></div>' +
            '</div>' +
            '<div class="mb-4">' +
              '<label class="block text-sm font-medium text-gray-700 mb-1">Status</label>' +
              '<select id="modalStatus" class="w-full rounded-lg border-gray-300">' +
                '<option value="Votação Planejada"' + (pauta && pauta.status === 'Votação Planejada' ? ' selected' : '') + '>Votação Planejada</option>' +
                '<option value="Votação Liberada"' + (pauta && pauta.status === 'Votação Liberada' ? ' selected' : '') + '>Votação Liberada</option>' +
                '<option value="Votação Encerrada"' + (pauta && pauta.status === 'Votação Encerrada' ? ' selected' : '') + '>Votação Encerrada</option>' +
              '</select>' +
            '</div>' +
            '<div class="mb-4">' +
              '<label class="block text-sm font-medium text-gray-700 mb-1">Nome da Aba (gerado automaticamente)</label>' +
              '<input type="text" id="modalAba" class="w-full rounded-lg border-gray-300 bg-gray-100" value="' + (pauta ? pauta.aba : '') + '" readonly>' +
              '<p class="mt-1 text-xs text-gray-500">O nome da aba é gerado automaticamente em camelCase a partir do nome da pauta.</p>' +
            '</div>' +
            '<div class="flex justify-end gap-2">' +
              '<button type="button" id="btnCancelPauta" class="px-4 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-50">Cancelar</button>' +
              '<button type="submit" class="px-4 py-2 rounded-lg bg-violet-600 text-white hover:bg-violet-700">Salvar</button>' +
            '</div>' +
          '</form>' +
        '</div>' +
      '</div>';
      $('body').append(modalHtml);
      
      $('#btnCancelPauta, #pautaModal').off('click').on('click', function(e){
        if (e.target === this) {
          $('#pautaModal').remove();
        }
      });
      
      // Função para converter para camelCase
      function toCamelCase(text) {
        if (!text) return '';
        // Remove acentos
        text = text.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
        // Divide em palavras
        var words = text.trim().split(/\s+/);
        if (words.length === 0) return '';
        var result = words[0].toLowerCase();
        for (var i = 1; i < words.length; i++) {
          var word = words[i].toLowerCase();
          if (word.length > 0) {
            result += word.charAt(0).toUpperCase() + word.slice(1);
          }
        }
        // Remove caracteres não alfanuméricos
        result = result.replace(/[^a-zA-Z0-9]/g, '');
        return result;
      }
      
      // Preenche o campo de aba ao abrir o modal
      if (pauta && pauta.aba) {
        $('#modalAba').val(pauta.aba);
      } else {
        var nomePauta = $('#modalNomePauta').val();
        var abaNome = toCamelCase(nomePauta);
        $('#modalAba').val(abaNome);
      }
      
      // Atualiza o nome da aba em tempo real quando o nome da pauta muda
      $('#modalNomePauta').off('input').on('input', function(){
        var nomePauta = $(this).val();
        var abaNome = toCamelCase(nomePauta);
        $('#modalAba').val(abaNome);
      });
      
      $('#pautaForm').off('submit').on('submit', function(e){
        e.preventDefault();
        var pautaData = {
          nomePauta: $('#modalNomePauta').val(),
          descricao: $('#modalDescricao').val(),
          opcao1: $('#modalOpcao1').val(),
          opcao2: $('#modalOpcao2').val(),
          opcao3: $('#modalOpcao3').val(),
          opcao4: $('#modalOpcao4').val(),
          status: $('#modalStatus').val()
          // Não envia aba, será gerada automaticamente no backend
        };
        if (isEdit && pauta) {
          pautaData.rowIndex = pauta.rowIndex;
        }
        google.script.run
          .withSuccessHandler(function(){
            $('#pautaModal').remove();
            loadPautas();
            setStatusMessage('Pauta salva com sucesso!', 'ok');
          })
          .withFailureHandler(function(e){
            setStatusMessage('Erro ao salvar pauta: ' + (e && e.message ? e.message : e), 'error');
          })
          .savePauta(pautaData);
      });
    }
  </script>
</body>
</html>

