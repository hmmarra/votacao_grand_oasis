<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Votação Subsíndico</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
  <div class="min-h-screen bg-gray-50 py-6 sm:py-10 px-3 sm:px-4 text-[17px] sm:text-base">
    <div class="max-w-2xl mx-auto">
      <div class="flex flex-col sm:flex-row items-start sm:items-center gap-3 mb-4 sm:mb-6">
        <div class="p-2 rounded-xl bg-indigo-100 text-indigo-700">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M2.25 12c0-2.248 0-4.122.116-5.527.119-1.44.36-2.527 1.035-3.388.676-.86 1.63-1.354 3.098-1.79C7.98.854 9.81.56 12 .56c2.19 0 4.019.294 5.501.736 1.469.436 2.422.93 3.098 1.79.676.861.916 1.948 1.035 3.388.116 1.405.116 3.279.116 5.527 0 2.248 0 4.123-.116 5.528-.119 1.44-.36 2.527-1.035 3.387-.676.862-1.63 1.356-3.098 1.792-1.482.441-3.311.735-5.501.735-2.19 0-4.02-.294-5.501-.735-1.469-.436-2.422-.93-3.098-1.792-.676-.86-.916-1.947-1.035-3.387C2.25 16.123 2.25 14.248 2.25 12Zm12.53-2.03a.75.75 0 0 0-1.06-1.06L11 11.62l-.72-.72a.75.75 0 1 0-1.06 1.06l1.25 1.25a.75.75 0 0 0 1.06 0l3.25-3.25Z" clip-rule="evenodd"/></svg>
        </div>
        <div>
          <h1 class="text-2xl font-semibold text-gray-800 leading-snug">Votação de Subsíndico</h1>
          <p class="text-sm text-gray-500">Digite seu CPF, busque seus dados e registre seu voto.</p>
        </div>
      </div>

      <div class="bg-white rounded-2xl shadow p-4 sm:p-6">
        <input type="hidden" id="cand-escolhido" />

        <div class="mb-4">
          <label for="cpf" class="block text-sm font-medium text-gray-700 mb-1">CPF</label>
          <div class="flex flex-col sm:flex-row gap-2">
            <input type="text" id="cpf" class="w-full sm:flex-1 rounded-lg border-gray-300 focus:border-indigo-500 focus:ring-indigo-500 h-12 text-base" placeholder="Digite seu CPF" required>
            <button type="button" id="btnBuscar" class="w-full sm:w-auto inline-flex items-center justify-center gap-2 rounded-lg bg-indigo-600 text-white px-5 py-3 hover:bg-indigo-700 text-base h-12">Buscar</button>
          </div>
          <p class="text-xs text-gray-500 mt-1">Após digitar, clique em Buscar para carregar seus dados.</p>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 sm:gap-4 mb-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Nome</label>
            <input type="text" id="nome" class="w-full rounded-lg border-gray-300 bg-gray-100 h-12 text-base" readonly>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Apartamento</label>
            <input type="text" id="apartamento" class="w-full rounded-lg border-gray-300 bg-gray-100 h-12 text-base" readonly>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Torre</label>
            <input type="text" id="torre" class="w-full rounded-lg border-gray-300 bg-gray-100 h-12 text-base" readonly>
          </div>
        </div>

        <div class="mb-6">
          <p class="block text-sm font-medium text-gray-700 mb-3">Escolha o Subsíndico</p>
          <div id="cards" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4"></div>
        </div>

        <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-3">
          <button type="button" id="btnVerPlacarSub" class="w-full sm:w-auto inline-flex items-center gap-2 rounded-lg bg-sky-600 text-white px-5 py-3 hover:bg-sky-700 text-base h-12">Ver Placar</button>
        </div>

        <p id="message" class="hidden mt-4 text-sm text-center sm:text-left"></p>
      </div>
    </div>
  </div>

  <div id="confirmModal" class="hidden fixed inset-0 z-50 items-center justify-center bg-black/50">
    <div class="mx-4 w-full max-w-md rounded-2xl bg-white p-6 shadow-lg">
      <h3 class="text-lg font-semibold text-gray-800 mb-2">Confirmar voto</h3>
      <p class="text-sm text-gray-600">Você confirma seu voto para <span id="confirmName" class="font-medium text-gray-800"></span>?</p>
      <div class="mt-6 flex justify-end gap-2">
        <button type="button" id="confirmCancel" class="rounded-lg border border-gray-300 px-4 py-2 text-gray-700 hover:bg-gray-50">Cancelar</button>
        <button type="button" id="confirmConfirm" class="rounded-lg bg-emerald-600 px-4 py-2 text-white hover:bg-emerald-700">Confirmar</button>
      </div>
    </div>
  </div>

  <script>
    function setStatusMessage(text, type) {
      var el = $('#message');
      el.removeClass('hidden').removeClass('text-emerald-700').removeClass('text-red-600');
      el.addClass(type === 'error' ? 'text-red-600' : 'text-emerald-700');
      el.text(text);
    }

    function navigateTo(view) {
      try {
        google.script.run.withSuccessHandler(function(base){
          var url = base || '';
          if (view) { url += (url.indexOf('?') === -1 ? '?' : '&') + 'view=' + encodeURIComponent(view); }
          window.top.location.href = url || ('?' + 'view=' + encodeURIComponent(view));
        }).getWebAppUrl();
      } catch (e) {
        var a = document.createElement('a');
        a.href = view ? ('?view=' + view) : '?';
        a.target = '_top';
        document.body.appendChild(a);
        a.click();
        a.remove();
      }
    }

    function renderCandidates(list){
      var html = '';
      list.forEach(function(name){
        html += '<div class="rounded-2xl border border-gray-100 bg-white p-4 sm:p-5 flex flex-col min-w-0">' +
                  '<div class="flex-1">' +
                    '<div class="text-lg font-semibold text-gray-800">'+ name +'</div>' +
                    '<p class="text-sm text-gray-500">Candidato</p>' +
                  '</div>' +
                  '<button type="button" data-cand="'+ name +'" class="btnVote w-full mt-3 inline-flex items-center justify-center gap-2 rounded-lg bg-emerald-600 text-white px-5 py-3 hover:bg-emerald-700 disabled:opacity-50 disabled:cursor-not-allowed text-base h-12" disabled>Votar</button>' +
                '</div>';
      });
      $('#cards').html(html);
    }

    function buscarCPF(){
      var cpf = $('#cpf').val();
      if (!cpf) { setStatusMessage('Por favor, digite um CPF para buscar.', 'error'); return; }
      $('#btnBuscar').prop('disabled', true).addClass('opacity-60');
      google.script.run
        .withSuccessHandler(function(res){
          window.currentVoterSub = res;
          $('#nome').val(res.nome).prop('readonly', true);
          $('#apartamento').val(res.apartamento).prop('readonly', true);
          $('#torre').val(res.torre).prop('readonly', true);
          if (res.votou) {
            setStatusMessage('Você já votou: ' + res.voto + '. Os botões foram desabilitados.', 'error');
            $('.btnVote').prop('disabled', true);
          } else {
            setStatusMessage('Dados encontrados. Escolha seu candidato e confirme o voto.', 'ok');
            $('.btnVote').prop('disabled', false);
          }
        })
        .withFailureHandler(function(e){
          setStatusMessage((e && e.message) ? e.message : 'Erro ao buscar CPF.', 'error');
          $('.btnVote').prop('disabled', true);
        })
        .getSubVoter(cpf);
      setTimeout(function(){ $('#btnBuscar').prop('disabled', false).removeClass('opacity-60'); }, 500);
    }

    function init(){
      $('#btnBuscar').off('click').on('click', buscarCPF);
      $('#btnVerPlacarSub').off('click').on('click', function(){ navigateTo('placarsubsindico'); });
      google.script.run.withSuccessHandler(renderCandidates).getSubCandidates();
      $(document).off('click', '.btnVote').on('click', '.btnVote', function(){
        if (!window.currentVoterSub || window.currentVoterSub.votou) { return; }
        var cand = $(this).data('cand');
        $('#confirmName').text(cand);
        $('#cand-escolhido').val(cand);
        $('#confirmModal').removeClass('hidden').addClass('flex');
      });
      $('#confirmCancel').off('click').on('click', function(){ $('#confirmModal').addClass('hidden').removeClass('flex'); });
      $('#confirmConfirm').off('click').on('click', function(){
        var cand = $('#cand-escolhido').val();
        var cpf = $('#cpf').val();
        if (!cand || !cpf) return;
        $('.btnVote').prop('disabled', true).addClass('opacity-60');
        $('#confirmModal').addClass('hidden').removeClass('flex');
        google.script.run
          .withSuccessHandler(function(){ setStatusMessage('Voto registrado com sucesso!', 'ok'); setTimeout(function(){ navigateTo('placarsubsindico'); }, 1000); })
          .withFailureHandler(function(e){ setStatusMessage('Erro ao registrar: ' + (e && e.message ? e.message : e), 'error'); $('.btnVote').prop('disabled', false).removeClass('opacity-60'); })
          .saveSubVote(cpf, cand);
      });
    }

    window.addEventListener('load', init);
  </script>
</body>
</html>

